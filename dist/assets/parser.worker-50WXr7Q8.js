(function(){"use strict";function u(o){const e=o.split(/(?=; action = \w+)/g),t=e.find(n=>n.includes("; action = lmem_assign")&&n.includes("; step = lmem_spec")),s={};if(t){const n=/;\s*(\w+)\s*=\s*([^;]+)/gi;let r;for(;(r=n.exec(t))!==null;){const[,c,m]=r;["lmem_bytes","lmem_banks","lmem_bank_bytes"].includes(c)&&(s[c]=Number(m.trim()))}console.log("[extractValidSections] 芯片信息:",s)}const i=e.filter(n=>n.includes("; action = lmem_assign")&&n.includes("; tag = iteration_result")&&!n.includes("; step = lmem_spec")),a=e.filter(n=>n.includes("; action = timestep_assign")&&n.includes("; tag = final_result")).slice(-1);return{lmemSections:i,timestepSections:a,chip:s}}class _{static FIELDS_WHITELIST=new Set(["op_name","op_type","addr","size","timestep_start","timestep_end","lmem_type","hold_in_lmem","status","tag","bank_id"]);parse(e){const t=this._groupBySettings(e);return this._processAllocationGroups(t)}_groupBySettings(e){const t=[];let s=null;return e.forEach(i=>{const{entry:a,settings:n}=this._parseSection(i);a&&((!s||!this._isSameSettings(s.settings,n))&&(s={settings:n,allocations:[]},t.push(s)),s.allocations.push(a))}),t}_parseSection(e){const t={},s={},i=/; (\w+) = ([^;]+)/g;let a;for(;(a=i.exec(e))!==null;){const[n,r,c]=a,m=this._convertValue(r,c.trim());(r==="shape_secs"||r==="allow_bank_conflict")&&(s[r]=m),this.constructor.FIELDS_WHITELIST.has(r)&&(t[r]=m)}return{entry:this._validateEntry(t),settings:s}}_processAllocationGroups(e){return e.map(t=>{const{settings:s,allocations:i}=t,{success:a,failed:n}=this._splitByStatus(i);let c=a.reduce((l,p)=>Math.max(l,p.addr+p.size),0);const m=n.map(l=>{const p={...l,addr:c};return c+=l.size,p}),f=Math.max(...a.map(l=>l.timestep_end),...n.map(l=>l.timestep_end));return{settings:s,allocations:[...a,...m].map(l=>({...l,bank_id:l.addr>>16&15,max_timestep:f}))}})}_splitByStatus(e){return e.reduce((t,s)=>(s.status==="success"?t.success.push(s):t.failed.push(s),t),{success:[],failed:[]})}_isSameSettings(e,t){return["shape_secs","allow_bank_conflict"].every(s=>JSON.stringify(e[s])===JSON.stringify(t[s]))}_convertValue(e,t){return t=t.trim(),["hold_in_lmem","allow_bank_conflict","one_loop"].includes(e)?t==="1"||t.toLowerCase()==="true":t.startsWith("0x")?parseInt(t,16):isNaN(t)?e==="shape_secs"?t.split(",").map(Number):t.startsWith('"')&&t.endsWith('"')?t.slice(1,-1):t:Number(t)}_validateEntry(e){return e.tag==="stamp"?null:["op_name","addr","size","timestep_start","timestep_end","status","tag"].every(s=>s in e)&&e.tag==="iteration_result"?e:null}}class d{parse(e){return e.length===0?[]:e[0].split(`
`).filter(i=>i.includes("; ts =")).map(i=>{try{return this._parseTimestepLine(i)}catch(a){return console.warn("解析timestep行失败:",a.message),null}}).filter(Boolean)}_parseTimestepLine(e){const t=e.match(/; ts = (\d+);/);if(!t)throw new Error("无效的时间步格式");return{ts:parseInt(t[1]),compute:this._extractOperations(e,"C"),loads:this._extractOperations(e,"L"),stores:this._extractOperations(e,"S")}}_extractOperations(e,t){if(t==="C"){const i=/C\("([^"]+)"\)[^"]*"([^"]+)"/g;return[...e.matchAll(i)].map(([a,n,r])=>({id:`${r}`,type:"compute",operation:`${n}`}))}const s=new RegExp(`${t}\\("([^"]+)", hold_in_lmem = (\\d)\\)->([^,\\]]+)`,"g");return[...e.matchAll(s)].map(([i,a,n,r])=>({id:a,hold_in_lmem:parseInt(n),target:r,type:t==="C"?"compute":t.toLowerCase()}))}}function g(o,e){const t=new Map(o.map(s=>[s.op_name,s]));return e.map(s=>({...s,compute:s.compute.map(i=>({...i,memory_allocation:t.get(i.id)})),memory_usage:h(s.ts,o)}))}function h(o,e){return e.filter(t=>t.timestep_start<=o&&t.timestep_end>=o).reduce((t,s)=>t+s.size,0)}self.onmessage=async o=>{const e=o.data;try{if(!e||typeof e!="string")throw new Error("Invalid input: rawLog must be a non-empty string");const{lmemSections:t,timestepSections:s,chip:i}=u(e);if(!t.length||!s.length)throw new Error("No valid sections found in the log file");const a=new _,n=new d,r=a.parse(t),c=n.parse(s);if(r.length&&i&&Object.assign(r[0].settings,i),console.log("[Worker] lmemData after chip merge:",r),!r||!c)throw new Error("Parser returned invalid data");const m=g(r[0].allocations,c);self.postMessage({lmem:r,timestep:c,summary:m})}catch(t){console.error("[Worker]",t),self.postMessage({error:t.message})}}})();
